#!/bin/bash

# bupt-net-login is a authenticator for BUPT (Beijing University
# of Posts and Telecommunications) campus network.
# Copyright (C) 2024 Charlie Chiang

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

# Just in case PATH is not set.
PATH=$PATH:/bin:/usr/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin

NC='\033[0m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'

datestr() {
    date +'%Y-%m-%d %H:%M:%S'
}

info() {
    echo -e "${CYAN}INFO${NC}[$(datestr)] $*"
}

warn() {
    echo -e "${YELLOW}WARN${NC}[$(datestr)] $*"
}

error() {
    echo -e "${RED}ERRO${NC}[$(datestr)] $*"
}

fatal() {
    echo -e "${RED}FATA${NC}[$(datestr)] $*"
    exit 1
}

# 获取系统网卡列表
get_network_interfaces() {
    if command -v ip >/dev/null 2>&1; then
        # Linux 系统使用 ip 命令
        ip link show | grep -E '^[0-9]+:' | awk -F': ' '{print $2}' | sed 's/@.*//'
    elif command -v ifconfig >/dev/null 2>&1; then
        # macOS/BSD 系统使用 ifconfig 命令
        ifconfig -l | tr ' ' '\n' | grep -v '^$'
    else
        warn "无法检测网卡，请手动指定网卡名称"
        return 1
    fi
}

# 检查网卡是否启用且有IP地址
check_interface_status() {
    local interface=$1
    if command -v ip >/dev/null 2>&1; then
        # Linux 系统
        if ip addr show "$interface" 2>/dev/null | grep -q "inet "; then
            return 0
        fi
    elif command -v ifconfig >/dev/null 2>&1; then
        # macOS/BSD 系统
        if ifconfig "$interface" 2>/dev/null | grep -q "inet "; then
            return 0
        fi
    fi
    return 1
}

# 获取网卡的IP地址
get_interface_ip() {
    local interface=$1
    if command -v ip >/dev/null 2>&1; then
        # Linux 系统
        ip addr show "$interface" 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d'/' -f1 | head -1
    elif command -v ifconfig >/dev/null 2>&1; then
        # macOS/BSD 系统
        ifconfig "$interface" 2>/dev/null | grep "inet " | awk '{print $2}' | head -1
    fi
}

# 使用指定网卡进行网络请求
curl_with_interface() {
    local interface=$1
    shift
    local ip=$(get_interface_ip "$interface")
    if [[ -n "$ip" ]]; then
        curl --interface "$interface" "$@"
    else
        curl "$@"
    fi
}

ask_cred() {
    # already set username and password in environment variables, skip
    if [[ -n "$BUPT_USERNAME" && -n "$BUPT_PASSWORD" ]]; then
        return
    fi

    # try to read saved username and password from file
    if [[ -f $HOME/.bupt-net-login ]]; then
        source $HOME/.bupt-net-login
    fi

    # if still not set, ask user to input
    if [[ -z "$BUPT_USERNAME" || -z "$BUPT_PASSWORD" ]]; then
        warn "你没有设置 BUPT_USERNAME 和 BUPT_PASSWORD 环境变量（例如 \"BUPT_USERNAME=2019000000 BUPT_PASSWORD=123456 $0\"），也没有保存密码。"
        echo "请手动输入学号和网关密码，你的信息将用于网关认证。"
        read -p '你的学号 Username: ' BUPT_USERNAME
        read -s -p '网关密码 Password: ' BUPT_PASSWORD
        echo

        read -p "是否保存用户名密码以方便下次手动登录？注意，你的凭据将被明文存储。(y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "BUPT_USERNAME='$BUPT_USERNAME'" >$HOME/.bupt-net-login
            echo "BUPT_PASSWORD='$BUPT_PASSWORD'" >>$HOME/.bupt-net-login
            chmod 600 $HOME/.bupt-net-login
            info "已保存你的凭据至 $HOME/.bupt-net-login ，如果你想删除凭据，请直接删除该文件。"
        fi
    fi
}

# default cron
cron="0-59/5 * * * *"

# Installation
if [[ "$1" == "install" ]]; then
    if ! which crontab >/dev/null; then
        fatal "你的系统没有 crontab ？"
    fi

    if ! cat "$0" 2>/dev/null | head -n1 | grep -q '#!/bin/bash'; then
        fatal "请从本地运行 bupt-net-login "
    fi

    if [[ -z $PREFIX ]]; then
        PREFIX=/usr/local/bin
    fi

    # Use user-specified cron, if possible.
    if [[ "$2" != "" ]]; then
        cron="$2"
    fi

    echo "你将要安装 bupt-net-login , 安装脚本将会做以下这些事："
    if [[ "$0" != "$PREFIX/bupt-net-login" ]]; then
        echo "  - 安装 $0 至 $PREFIX/bupt-net-login 。如果你希望更改目标位置, 请设置 PREFIX 环境变量。"
    fi
    if crontab -l 2>/dev/null | grep -q "/bupt-net-login"; then
        echo "  - 移除先前安装的 bupt-net-login cron job 。其他 cron job 不受影响。"
    fi
    echo "  - 安装 cron job ($cron) 至当前用户 $USER 。如果你需要自定义 cron , 添加命令行参数即可, 例如 $0 install \"$cron\"。"

    read -p "是否继续? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        fatal "你选择了取消安装"
    fi

    mkdir -p "$PREFIX"
    if [[ "$0" != "$PREFIX/bupt-net-login" ]] && ! install "$0" "$PREFIX/bupt-net-login"; then
        if [[ $EUID -ne 0 && $PREFIX == "/usr/local/bin" ]]; then
            echo "默认安装位置 /usr/local/bin 需要 root 权限, 你需要以 root 权限运行 (sudo)。"
            echo "如果你不想用 root 账户，请设置 PREFIX 环境变量以改变安装位置。"
        fi
        fatal "安装失败"
    fi

    ask_cred

    cronfull="$cron BUPT_USERNAME='$BUPT_USERNAME' BUPT_PASSWORD='$BUPT_PASSWORD' $PREFIX/bupt-net-login >>/tmp/bupt-net-login.log 2>&1"

    if ! crontab -l 2>/dev/null | sed -e "\_/bupt-net-login_d" | echo -e "$(cat -)\n$cronfull\n" | crontab -; then
        fatal "安装失败"
    fi

    info "安装成功"
    exit 0
elif [[ "$1" == "uninstall" ]]; then
    if crontab -l 2>/dev/null | grep -q /bupt-net-login; then
        info "正在删除当前用户 ($USER) 的 bupt-net-login cronjob "
        if ! crontab -l 2>/dev/null | sed -e "\_/bupt-net-login_d" | crontab -; then
            fatal "删除 cronjob 失败"
        fi
    else
        warn "当前用户 ($USER) 未安装 bupt-net-login cronjob"
    fi

    if [[ -f "$HOME/.bupt-net-login" ]]; then
        info "正在删除保存的用户名密码"
        rm -f $HOME/.bupt-net-login
    fi

    echo "任何后台服务已清除，如果你需要删除 bupt-net-login 自身，运行 \"rm $(which bupt-net-login)\""
    exit 0
elif [[ "$1" == "interfaces" ]]; then
    echo "检测到的网卡列表："
    echo "=================="
    if get_network_interfaces; then
        echo
        echo "启用的网卡（有IP地址）："
        echo "=================="
        for interface in $(get_network_interfaces); do
            if check_interface_status "$interface"; then
                local ip=$(get_interface_ip "$interface")
                echo "✓ $interface ($ip)"
            else
                echo "✗ $interface (未启用或无IP)"
            fi
        done
    fi
    exit 0
elif [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]]; then
    echo "bupt-net-login     - 北京邮电大学校园网认证脚本（网卡维度版）"
    echo "Usage: $0 [install|uninstall|interfaces|help] [interface_name]"
    echo "                   - 不加参数即执行网关认证（自动检测网卡）"
    echo "    install [cron] - 安装认证 cronjob, 定期检查登录。"
    echo "                     cron 参数可选，默认 cron 为 \"$cron\""
    echo "    uninstall      - 删除 cronjob 和保存的用户名密码"
    echo "    interfaces     - 显示所有网卡信息"
    echo "    help           - 显示此帮助信息"
    echo "    [interface]    - 指定网卡名称进行认证"
    echo ""
    echo "示例："
    echo "  $0                    # 自动检测网卡并认证"
    echo "  $0 eth0              # 使用 eth0 网卡进行认证"
    echo "  $0 wlp6s0            # 使用 wlp6s0 网卡进行认证"
    echo "  $0 install           # 安装定时任务"
    echo "  $0 interfaces        # 查看网卡信息"
    echo "  $0 help              # 显示帮助信息"
    exit 0
fi

# must have curl installed
if ! which curl >/dev/null; then
    fatal "请先安装 curl\n你可以根据你的包管理器选择合适的命令：\n  - sudo apt install curl\n  - sudo yum install curl\n  - sudo pacman -S curl\n  - brew install curl"
fi

if [[ -z "$REDIRECTION_TEST_URL" ]]; then
    REDIRECTION_TEST_URL="http://captive.apple.com/"
fi

debug_args=""
if [[ -n "$DEBUG" ]]; then
    debug_args+="-v"
fi

cookie_file=$(mktemp)

cleanup() {
    rm -f "$cookie_file"
}

trap cleanup EXIT

login() {
    local redirected_auth_url=$1
    local interface=$2
    
    if [[ -z "$redirected_auth_url" ]]; then
        error "未指定认证地址"
        return 1
    fi

    local interface_info=""
    if [[ -n "$interface" ]]; then
        local ip=$(get_interface_ip "$interface")
        interface_info=" (网卡: $interface, IP: $ip)"
    fi

    info "准备使用账号 $BUPT_USERNAME 进行认证, 认证地址 $redirected_auth_url$interface_info"

    info "获取 cookie ..."
    if ! curl_with_interface "$interface" $debug_args \
        -s -c "$cookie_file" \
        "$redirected_auth_url" >/dev/null; then
        error "获取 cookie 失败"
        return 1
    fi

    info "正在认证..."
    if ! curl_with_interface "$interface" $debug_args \
        -s -b "$cookie_file" \
        -X POST \
        --data-urlencode "user=$BUPT_USERNAME" \
        --data-urlencode "pass=$BUPT_PASSWORD" \
        "${redirected_auth_url/index/login}" >/dev/null; then
        error "发送登录请求失败, 请检查网络连接"
        return 1
    fi

    test_login "$interface"
}

test_login() {
    local interface=$1
    curl_with_interface "$interface" $debug_args -4s "${REDIRECTION_TEST_URL}" | grep -q "Success"
}

check_response() {
    local redirect_resp=$1
    local interface=$2
    
    if [[ $redirect_resp == *Success* ]]; then
        local interface_info=""
        if [[ -n "$interface" ]]; then
            interface_info=" (网卡: $interface)"
        fi
        info "您已经登录, 无需进一步操作$interface_info"
        exit 0
    elif [[ $redirect_resp == *10.3.8* ]]; then
        local interface_info=""
        if [[ -n "$interface" ]]; then
            interface_info=" (网卡: $interface)"
        fi
        info "您未登录, 准备认证...$interface_info"
        ask_cred
        if login "$redirect_resp" "$interface"; then
            info "账号 $BUPT_USERNAME 认证成功$interface_info"
            exit 0
        else
            fatal "账号 $BUPT_USERNAME 认证失败$interface_info"
        fi
    elif [[ $redirect_resp == *http-equiv* ]]; then # 无线网，多一次跳转
        redirect_resp=$(echo "$redirect_resp " | grep -o "url=.*'")
        redirect_resp=${redirect_resp/url=/}
        redirect_resp=${redirect_resp/\'/}
        REDIRECTION_TEST_URL="${redirect_resp}"
        main "$interface"
    else
        local interface_info=""
        if [[ -n "$interface" ]]; then
            interface_info=" (网卡: $interface)"
        fi
        error "收到来自 $REDIRECTION_TEST_URL 的未知响应: \"$redirect_resp\" 本次认证失败$interface_info, 以下为 debug 信息"
        curl_with_interface "$interface" -4vsS "${REDIRECTION_TEST_URL}"
        exit 1
    fi
}

main() {
    local interface=$1
    
    # 如果没有指定网卡，自动检测
    if [[ -z "$interface" ]]; then
        info "未指定网卡，正在自动检测..."
        local available_interfaces=()
        
        for iface in $(get_network_interfaces); do
            if check_interface_status "$iface"; then
                available_interfaces+=("$iface")
            fi
        done
        
        if [[ ${#available_interfaces[@]} -eq 0 ]]; then
            fatal "未找到可用的网卡"
        elif [[ ${#available_interfaces[@]} -eq 1 ]]; then
            interface=${available_interfaces[0]}
            info "自动选择网卡: $interface"
        else
            info "检测到多个可用网卡: ${available_interfaces[*]}"
            info "将使用第一个可用网卡: ${available_interfaces[0]}"
            interface=${available_interfaces[0]}
        fi
    else
        # 检查指定的网卡是否可用
        if ! check_interface_status "$interface"; then
            fatal "指定的网卡 $interface 不可用或无IP地址"
        fi
        info "使用指定网卡: $interface"
    fi
    
    local interface_info=" (网卡: $interface)"
    info "开始检测网络状态$interface_info"
    
    redirect_resp="$(curl_with_interface "$interface" $debug_args -4sS -w '%{redirect_url}' "${REDIRECTION_TEST_URL}")"
    check_response "$redirect_resp" "$interface"
}

main "$1"